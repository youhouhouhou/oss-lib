<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Jackson2Configurator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oss-lib-common</a> &gt; <a href="index.source.html" class="el_package">com.yirendai.oss.lib.common</a> &gt; <span class="el_source">Jackson2Configurator.java</span></div><h1>Jackson2Configurator.java</h1><pre class="source lang-java linenums">package com.yirendai.oss.lib.common;

import static com.fasterxml.jackson.databind.SerializationFeature.WRITE_DATES_AS_TIMESTAMPS;
import static com.yirendai.oss.lib.common.Defaults.UTC_P8;
import static java.lang.Boolean.FALSE;
import static java.lang.Boolean.parseBoolean;

import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.Module;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializationFeature;
import com.fasterxml.jackson.datatype.joda.JodaModule;

import lombok.extern.slf4j.Slf4j;

import org.slf4j.LoggerFactory;
import org.springframework.core.env.PropertyResolver;

import java.lang.reflect.Method;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Optional;

/**
 * Created by zhanghaolun on 16/7/28.
 */
public interface Jackson2Configurator&lt;T extends Enum&lt;T&gt; &amp; Jackson2Configurator&lt;T&gt;&gt; {

  String JACKSON_JAXB_ENABLED = &quot;jackson.jaxb.enabled&quot;;
  String XMLMAPPER_CLASSNAME = &quot;com.fasterxml.jackson.dataformat.xml.XmlMapper&quot;;

  &lt;M extends ObjectMapper&gt; M config(PropertyResolver propertyResolver, M mapper);

  default Optional&lt;Class&lt;?&gt;&gt; findClass(final String className) {
    Class&lt;?&gt; classFound;
    try {
<span class="nc" id="L39">      classFound = Class.forName(className);</span>
<span class="nc" id="L40">    } catch (final ClassNotFoundException ex) {</span>
<span class="nc" id="L41">      LoggerFactory.getLogger(Jackson2Configurator.class).debug(&quot;{} not found&quot;, className, ex);</span>
<span class="nc" id="L42">      classFound = null;</span>
<span class="nc" id="L43">    }</span>
<span class="nc" id="L44">    return Optional.ofNullable(classFound);</span>
  }

  default Optional&lt;String&gt; getProperty(final PropertyResolver propertyResolver, final String key) {
    final Optional&lt;String&gt; result;
<span class="nc bnc" id="L49" title="All 2 branches missed.">    if (propertyResolver != null) {</span>
<span class="nc" id="L50">      final String property = propertyResolver.getProperty(key);</span>
<span class="nc" id="L51">      result = Optional.ofNullable(property);</span>
<span class="nc" id="L52">    } else {</span>
<span class="nc" id="L53">      result = Optional.empty();</span>
    }
<span class="nc" id="L55">    return result;</span>
  }

  default &lt;M extends ObjectMapper&gt; Boolean isXmlMapper(final M mapper) {
<span class="nc" id="L59">    final Optional&lt;Class&lt;?&gt;&gt; optional = findClass(XMLMAPPER_CLASSNAME);</span>
<span class="nc" id="L60">    return optional.map(xmlMapperClass -&gt; xmlMapperClass.isAssignableFrom(mapper.getClass())).orElse(FALSE);</span>
  }

  // ---------------------------------------- ----------------------------------------

  /**
   * Build-in jackson2 configurators.
   *
   * @author zhanghaolun
   */
<span class="pc" id="L70">  @Slf4j</span>
<span class="fc" id="L71">  enum BuildinJackson2Configurators implements Jackson2Configurator&lt;BuildinJackson2Configurators&gt; {</span>
<span class="fc" id="L72">    JACKSON2_DEFAULT_CONFIGURATOR {</span>
      @Override
      public &lt;M extends ObjectMapper&gt; M config(final PropertyResolver propertyResolver, final M mapper) {
<span class="nc" id="L75">        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);</span>
<span class="nc" id="L76">        mapper.configure(JsonParser.Feature.ALLOW_UNQUOTED_FIELD_NAMES, true);</span>
<span class="nc" id="L77">        mapper.configure(SerializationFeature.INDENT_OUTPUT, false);</span>

<span class="nc" id="L79">        mapper.configure(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY, true);</span>
<span class="nc" id="L80">        mapper.configure(JsonGenerator.Feature.QUOTE_NON_NUMERIC_NUMBERS, false);</span>
<span class="nc" id="L81">        mapper.configure(JsonParser.Feature.ALLOW_NON_NUMERIC_NUMBERS, true);</span>
<span class="nc" id="L82">        return mapper;</span>
      }
    },
<span class="fc" id="L85">    JACKSON2_DATETIME_CONFIGURATOR {</span>
      @Override
      public &lt;M extends ObjectMapper&gt; M config(final PropertyResolver propertyResolver, final M mapper) {
<span class="nc" id="L88">        mapper.setTimeZone(Defaults.UTC_P8.toTimeZone());</span>
<span class="nc" id="L89">        mapper.registerModule(new JodaModule());</span>
        // Jdk8Module ?
<span class="nc" id="L91">        mapper.disable(WRITE_DATES_AS_TIMESTAMPS);</span>
        // disable WRITE_DATES_WITH_ZONE_ID ?
        // ISODateTimeFormat.basicDateTime()
<span class="nc" id="L94">        final DateFormat formatJdk = new SimpleDateFormat(Defaults.PATTERN_JAVA_ISO8601);</span>
<span class="nc" id="L95">        formatJdk.setTimeZone(UTC_P8.toTimeZone());</span>
<span class="nc" id="L96">        mapper.setDateFormat(formatJdk);</span>
<span class="nc" id="L97">        return mapper;</span>
      }
    },
<span class="fc" id="L100">    JACKSON2_HAL_CONFIGURATOR {</span>

      private static final String MODULE_CLASS = &quot;org.springframework.hateoas.hal.Jackson2HalModule&quot;;

      @Override
      public &lt;M extends ObjectMapper&gt; M config(final PropertyResolver propertyResolver, final M mapper) {
<span class="nc" id="L106">        final Optional&lt;Class&lt;?&gt;&gt; moduleClass = this.findClass(MODULE_CLASS);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (moduleClass.isPresent()) {</span>
          // need HalHandlerInstantiator or lead to exception on data-rest request
<span class="nc" id="L109">          final Boolean isAlreadyRegisteredIn = this.isAlreadyRegisteredIn(mapper, moduleClass.get());</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">          if (!isAlreadyRegisteredIn) {</span>
            try {
<span class="nc" id="L112">              mapper.registerModule((Module) moduleClass.get().newInstance());</span>
<span class="nc" id="L113">            } catch (final ReflectiveOperationException ex) {</span>
<span class="nc" id="L114">              log.info(&quot;Jackson2HalModule config error&quot;, ex);</span>
<span class="nc" id="L115">            }</span>
          }
        }
<span class="nc" id="L118">        return mapper;</span>
      }

      &lt;M extends ObjectMapper&gt; Boolean isAlreadyRegisteredIn(final M mapper, final Class&lt;?&gt; jackson2HalModuleClass) {
        Boolean result;
        try {
<span class="nc" id="L124">          final Method isAlreadyRegisteredIn = jackson2HalModuleClass.getDeclaredMethod( //</span>
            &quot;isAlreadyRegisteredIn&quot;, ObjectMapper.class);
<span class="nc" id="L126">          result = (Boolean) isAlreadyRegisteredIn.invoke(null, mapper);</span>
<span class="nc" id="L127">        } catch (final ReflectiveOperationException | SecurityException | IllegalArgumentException ex) {</span>
<span class="nc" id="L128">          log.info(&quot;Jackson2HalModule config error&quot;, ex);</span>
<span class="nc" id="L129">          result = FALSE;</span>
<span class="nc" id="L130">        }</span>
<span class="nc" id="L131">        return result;</span>
      }
    },
    /**
     * see: http://wiki.fasterxml.com/JacksonJAXBAnnotations
     * see: https://github.com/FasterXML/jackson-module-jaxb-annotations
     */
<span class="fc" id="L138">    JACKSON2_JAXB_ANNOTATION_CONFIGUATOR {</span>

      private static final String MODULE_CLASS = &quot;com.fasterxml.jackson.module.jaxb.JaxbAnnotationModule&quot;;
      private static final String JAXB_ANNOTATION_INTROSPECTOR_CLASS = //
        &quot;com.fasterxml.jackson.module.jaxb.JaxbAnnotationIntrospector&quot;;

      @Override
      public &lt;M extends ObjectMapper&gt; M config(final PropertyResolver propertyResolver, final M mapper) {
<span class="nc" id="L146">        final Boolean isXmlMapper = this.isXmlMapper(mapper);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        final String jaxbEnabledDefault = isXmlMapper ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc" id="L148">        final Boolean jaxbEnabled = parseBoolean( //</span>
<span class="nc" id="L149">          this.getProperty(propertyResolver, JACKSON_JAXB_ENABLED).orElse(jaxbEnabledDefault));</span>

<span class="nc" id="L151">        final Optional&lt;Class&lt;?&gt;&gt; moduleClass = this.findClass(MODULE_CLASS);</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">        if (jaxbEnabled &amp;&amp; moduleClass.isPresent()) {</span>
          try {
<span class="nc" id="L154">            final Class&lt;?&gt; jaxbClass = this.findClass(JAXB_ANNOTATION_INTROSPECTOR_CLASS).get();</span>
<span class="nc" id="L155">            final Module module = (Module) moduleClass.get().getConstructor(jaxbClass) //</span>
<span class="nc" id="L156">              .newInstance(new Jackson2HackedJaxbAnnotationIntrospector());</span>
<span class="nc" id="L157">            final Class&lt;?&gt; enumType = this.findClass(MODULE_CLASS + &quot;$Priority&quot;).orElse(null);</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">            final String priorityName = isXmlMapper ? &quot;PRIMARY&quot; : &quot;SECONDARY&quot;;</span>
<span class="nc" id="L160">            final Object priority = this.getEnumValue(enumType, priorityName);</span>
<span class="nc" id="L161">            final Method setPriorityMethod = moduleClass.get().getDeclaredMethod(&quot;setPriority&quot;, enumType);</span>
<span class="nc" id="L162">            setPriorityMethod.invoke(module, priority);</span>

<span class="nc" id="L164">            mapper.registerModule(module);</span>
<span class="nc" id="L165">          } catch (final ReflectiveOperationException ex) {</span>
<span class="nc" id="L166">            log.info(&quot;JaxbAnnotationModule config error&quot;, ex);</span>
<span class="nc" id="L167">          }</span>
        }
<span class="nc" id="L169">        return mapper;</span>
      }

      private Object getEnumValue(final Class&lt;?&gt; enumType, final String name) throws ReflectiveOperationException {
        final Object result;
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (enumType != null) {</span>
<span class="nc" id="L175">          final Method method = enumType.getDeclaredMethod(&quot;valueOf&quot;, String.class);</span>
<span class="nc" id="L176">          result = method.invoke(enumType, name);</span>
<span class="nc" id="L177">        } else {</span>
<span class="nc" id="L178">          result = null;</span>
        }
<span class="nc" id="L180">        return result;</span>
      }
    };

    @Override
    public abstract &lt;M extends ObjectMapper&gt; M config(PropertyResolver propertyResolver, M objectMapper);
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>