<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ResolvedError.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oss-lib-errorhandle</a> &gt; <a href="index.source.html" class="el_package">com.yirendai.oss.lib.errorhandle.api</a> &gt; <span class="el_source">ResolvedError.java</span></div><h1>ResolvedError.java</h1><pre class="source lang-java linenums">package com.yirendai.oss.lib.errorhandle.api;

import static com.google.common.collect.Maps.newLinkedHashMap;
import static lombok.AccessLevel.PRIVATE;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.JsonProperty;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import lombok.extern.slf4j.Slf4j;

import org.apache.commons.lang3.ArrayUtils;
import org.codehaus.jackson.map.annotate.JsonSerialize;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;

import java.io.Serializable;
import java.util.Map;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlElementWrapper;
import javax.xml.bind.annotation.XmlElements;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlType;

/**
 * 经过解析的错误信息.
 *
 * &lt;p&gt;
 * Created by zhanghaolun on 16/7/1.
 * &lt;/p&gt;
 */
@XmlRootElement(name = &quot;error&quot;) // Jaxb2RootElementHttpMessageConverter
@XmlAccessorType(XmlAccessType.FIELD)
@XmlType(propOrder = {&quot;error&quot;, &quot;exception&quot;, &quot;errors&quot;, &quot;message&quot;, &quot;path&quot;, &quot;status&quot;, &quot;timestamp&quot;, &quot;trace&quot;, //
  &quot;datetime&quot;, &quot;headers&quot;, &quot;localizedMessage&quot;, &quot;tracks&quot;})
@JsonInclude(JsonInclude.Include.NON_EMPTY) // for Jackson 2.x
@JsonSerialize(include = JsonSerialize.Inclusion.NON_EMPTY) // for Jackson 1.x
<span class="pc" id="L47">@Builder(builderMethodName = &quot;resolvedErrorBuilder&quot;)</span>
<span class="fc" id="L48">@AllArgsConstructor(access = PRIVATE)</span>
<span class="nc" id="L49">@ToString</span>
<span class="pc bpc" id="L50" title="39 of 54 branches missed.">@EqualsAndHashCode(of = {&quot;error&quot;, &quot;exception&quot;, &quot;path&quot;, &quot;status&quot;, &quot;timestamp&quot;, &quot;localizedMessage&quot;})</span>
<span class="fc" id="L51">@Setter(PRIVATE)</span>
@Getter
<span class="fc" id="L53">@Slf4j</span>
public class ResolvedError implements Serializable {

  public static final String RESOLVED_ERROR_COOKIE = &quot;resolvedErrorCookie&quot;;
  public static final String RESOLVED_ERROR_OBJECT = &quot;resolvedError&quot;;
  static final String HEADER_RESOLVED_ERROR = &quot;RESOLVED-ERROR&quot;;
  private static final long serialVersionUID = 1L;

  // ------------------------------ basic ------------------------------
  @JsonProperty(&quot;error&quot;)
<span class="fc" id="L63">  private String error;</span>
  /**
   * 解析得到的 数据验证错误信息.
   * Nested XmlElements see: https://github.com/FasterXML/jackson-module-jaxb-annotations/issues/42
   */
  @JsonProperty(&quot;errors&quot;)
  @XmlElementWrapper(name = &quot;errors&quot;)
  @XmlElements(@XmlElement(name = &quot;error&quot;))
<span class="fc" id="L71">  private ValidationError[] errors;</span>
  @XmlElement
<span class="fc" id="L73">  private String exception;</span>
<span class="fc" id="L74">  private String message;</span>
<span class="fc" id="L75">  private String path;</span>
<span class="fc" id="L76">  private Integer status;</span>
<span class="fc" id="L77">  private Long timestamp;</span>
<span class="fc" id="L78">  private String trace;</span>
  // ------------------------------ extended ------------------------------
  /**
   * ISO8601 string.
   */
<span class="fc" id="L83">  private String datetime;</span>
  /**
   * 解析得到的 异常响应头信息.
   */
  @JsonProperty(&quot;headers&quot;)
  @XmlElementWrapper(name = &quot;headers&quot;)
  @XmlElement(name = &quot;header&quot;)
<span class="fc" id="L90">  private HttpHeader[] headers;</span>
  /**
   * 解析得到的 错误信息.
   */
<span class="fc" id="L94">  private String localizedMessage;</span>
  /**
   * 解析得到的 异常的调用路径 (RPC).
   */
  @JsonProperty(&quot;tracks&quot;)
  @XmlElementWrapper(name = &quot;tracks&quot;)
  @XmlElement(name = &quot;track&quot;)
<span class="fc" id="L101">  private String[] tracks;</span>

<span class="fc" id="L103">  private ResolvedError() {</span>
<span class="fc" id="L104">    this.headers = HttpHeader.fromHttpHeaders(newHttpHeaders());</span>
<span class="fc" id="L105">  }</span>

  public static HttpHeaders newHttpHeaders() {
<span class="fc" id="L108">    final HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L109">    headers.add(HEADER_RESOLVED_ERROR, HEADER_RESOLVED_ERROR);</span>
<span class="fc" id="L110">    return headers;</span>
  }

  public static ResolvedError fromErrorAttributes(final Map&lt;String, Object&gt; map) {
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">    return map == null ? null : ResolvedError.resolvedErrorBuilder()</span>
      // basic
<span class="fc" id="L116">      .error((String) map.get(&quot;error&quot;)) //</span>
<span class="fc" id="L117">      .errors((ValidationError[]) map.get(&quot;errors&quot;)) //</span>
<span class="fc" id="L118">      .exception((String) map.get(&quot;exception&quot;))</span>
<span class="fc" id="L119">      .message((String) map.get(&quot;message&quot;)) //</span>
<span class="fc" id="L120">      .path((String) map.get(&quot;path&quot;)) //</span>
<span class="fc" id="L121">      .status((Integer) map.get(&quot;status&quot;)) //</span>
<span class="fc" id="L122">      .timestamp((Long) map.get(&quot;timestamp&quot;)) //</span>
<span class="fc" id="L123">      .trace((String) map.get(&quot;trace&quot;)) //</span>
      // extended
<span class="fc" id="L125">      .datetime((String) map.get(&quot;datetime&quot;))</span>
<span class="fc" id="L126">      .headers((HttpHeader[]) map.get(&quot;headers&quot;)) //</span>
<span class="fc" id="L127">      .localizedMessage((String) map.get(&quot;localizedMessage&quot;)) //</span>
<span class="fc" id="L128">      .tracks((String[]) map.get(&quot;tracks&quot;)).build();</span>
  }

  @JsonIgnore
  @org.codehaus.jackson.annotate.JsonIgnore
  public HttpStatus getHttpStatus() {
    HttpStatus result;
    try {
<span class="fc" id="L136">      result = HttpStatus.valueOf(this.status);</span>
<span class="nc" id="L137">    } catch (final Exception ex) {</span>
<span class="nc" id="L138">      result = HttpStatus.INTERNAL_SERVER_ERROR;</span>
<span class="nc" id="L139">      log.debug(&quot;error parse http status {}&quot;, this.status, ex);</span>
<span class="fc" id="L140">    }</span>
<span class="fc" id="L141">    return result;</span>
  }

  /**
   * before set into cookie, call this method to avoid header size exceed limit.
   *
   * @return this
   */
  public ResolvedError eraseTraces() {
<span class="fc" id="L150">    this.setTracks(null);</span>
<span class="fc" id="L151">    this.setTrace(null);</span>
<span class="fc" id="L152">    return this;</span>
  }

  public ResolvedError trackPrepend(final String track) {
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">    this.tracks = this.tracks != null ? //</span>
<span class="pc" id="L157">      ArrayUtils.add(this.tracks, 0, track) : //</span>
      new String[]{track};
<span class="fc" id="L159">    return this;</span>
  }

  public Map&lt;String, Object&gt; toErrorAttributes() {
<span class="fc" id="L163">    final Map&lt;String, Object&gt; map = newLinkedHashMap();</span>
    // basic
<span class="fc" id="L165">    map.put(&quot;error&quot;, this.error);</span>
<span class="fc" id="L166">    map.put(&quot;errors&quot;, this.errors);</span>
<span class="fc" id="L167">    map.put(&quot;exception&quot;, this.exception);</span>
<span class="fc" id="L168">    map.put(&quot;message&quot;, this.message);</span>
<span class="fc" id="L169">    map.put(&quot;path&quot;, this.path);</span>
<span class="fc" id="L170">    map.put(&quot;status&quot;, this.status);</span>
<span class="fc" id="L171">    map.put(&quot;timestamp&quot;, this.timestamp);</span>
<span class="fc" id="L172">    map.put(&quot;trace&quot;, this.trace);</span>
    // extended
<span class="fc" id="L174">    map.put(&quot;datetime&quot;, datetime);</span>
<span class="fc" id="L175">    map.put(&quot;headers&quot;, this.headers);</span>
<span class="fc" id="L176">    map.put(&quot;localizedMessage&quot;, this.localizedMessage);</span>
<span class="fc" id="L177">    map.put(&quot;tracks&quot;, this.tracks);</span>

<span class="fc bfc" id="L179" title="All 2 branches covered.">    map.entrySet().removeIf(e -&gt; e.getValue() == null);</span>
<span class="fc" id="L180">    return map;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>